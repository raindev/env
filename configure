#!/bin/bash -i
set -eo pipefail

if [[ $(hostname) == "void" ]]; then
	echo -e "Welcome to the void!"

	echo -e "\nSyncing the repositories and upgrading the system"
	xbps-install --sync --update
	echo -e "\nInstalling packages"
	xargs < void-linux/packages xbps-install --yes
fi

if [[ "$OSTYPE" == linux* ]]; then
	echo -e "Configuring Linux"
	copy="xclip -sel clip"
	open=xdg-open
elif [[ "$OSTYPE" == darwin* ]]; then
	echo -e "\nThinking differently"

	copy=pbcopy
	open=open

	echo -e "\nInstalling updates"
	sudo softwareupdate --install --recommended
	echo -e "\nUpgrading packages"
	brew upgrade
	echo -e "\nInstalling packages"
	brew bundle --file=mac/Brewfile
else
	echo "Unrecognized or unsupported system"
	exit 1
fi

ssh_key="$HOME/.ssh/id_ed25519"
if [ ! -e "$ssh_key" ]; then
	echo -e "\nGenerating SSH keys"
	ssh-keygen -t ed25519 -f "$ssh_key"
	eval "$(ssh-agent -s)"
	ssh-add
	echo -e "\nCopying the public SSH key"
	$copy < "$ssh_key.pub"
	echo "Add the key to GitHub"
	read -r
	$open https://github.com/settings/ssh/new
	echo "Add the key to GitLab"
	read -r
	$open https://gitlab.com/-/profile/keys
fi

if [ -z "$SSH_AUTH_SOCK" ]; then
	echo -e "\nStarting SSH agent"
	eval "$(ssh-agent -s)"
	ssh-add
fi

echo -e "\nSetting up dotfiles"
if [ ! -e "$HOME/code/dotfiles" ]; then
	git clone git@github.com:raindev/dotfiles.git \
		"$HOME/code/dotfiles"
fi
cd "$HOME/code/dotfiles/"
git stash
git pull --ff-only
git stash show && git stash pop
make all
cd - > /dev/null

echo -e "\nSetting up scripts"
if [ ! -e "$HOME/code/scripts" ]; then
	git clone git@github.com:raindev/scripts.git \
		"$HOME/code/scripts"
fi
cd "$HOME/code/scripts/"
git stash
git pull --ff-only
git stash show && git stash pop
cd -

if ! gpg --list-key andrew@raindev.io > /dev/null; then
	echo -e "\nSetting up GPG"
	echo "Insert the smartcard"
	read -r
	echo "Fetch the public key"
	gpg --edit-card
	echo "Set key trust level"
	gpg --edit-key
fi

if [ ! -e "$HOME/.password-store" ]; then
	echo -e "\nSetting up pass"
	git clone git@gitlab.com:raindev/passwords.git\
		"$HOME/.password-store"
	pass git init
fi
echo -e "\nUpdating password store"
pass git pull --rebase
pass git push

echo -e "\nEnsuring symlinks exist"
[ -e "$HOME/notes" ] || \
	ln --symbolic "$HOME/Sync/notes" "$HOME/notes"
[ -e "$HOME/org" ] || \
	ln --symbolic "$HOME/notes/org" "$HOME/org"
[ -e "$HOME/cs" ] || \
	ln --symbolic "$HOME/notes/cheatsheets" "$HOME/cs"

echo -e "\nAll done. Enjoy your $(date +%A)!"
