#!/bin/bash -i
set -exo pipefail

if [[ $(hostname) == "void" ]]; then
	echo "Welcome to the void!"

	source_dir=void-linux/
	home=/home/raindev

	echo "Syncing the repositories and upgrading the system"
	xbps-install --sync --update
	echo "Installing packages"
	xargs <$source_dir/packages xbps-install --yes

	if [ ! -e "$home/.ssh/id_ed25519" ]; then
		echo "Generating SSH keys"
		su raindev -c "ssh-keygen -t ed25519"
		eval "$(su raindev -c 'ssh-agent -s')"
		su raindev -c ssh-add
		echo "Copying the public SSH key"
		xclip -selection clipboard < "$home/.ssh/id_ed25519.pub"
		echo "Add the key to GitHub"
		su raindev -c "xdg-open https://github.com/settings/ssh/new"
		read -r
		echo "Add the key to GitLab"
		su raindev -c "xdg-open https://gitlab.com/-/profile/keys"
	fi

	if [ -z "$SSH_AUTH_SOCK" ]; then
		eval "$(su raindev -c 'ssh-agent -s')"
		su raindev -c ssh-add
	fi

	echo "Setting up dotfiles"
	if [ ! -e "$home/code/dotfiles" ]; then
		su raindev -c "git clone git@github.com:raindev/dotfiles.git \
			'$home/code/dotfiles'"
	fi
	cd /home/raindev/code/dotfiles/
	su raindev -c make all
	cd -

	echo "Setting up scripts"
	if [ ! -e "$home/code/scripts" ]; then
		su raindev -c "git clone git@github.com:raindev/scripts.git \
			'$home/code/scripts'"
	fi

else
	echo "Unrecognized or unsupported system"
fi
